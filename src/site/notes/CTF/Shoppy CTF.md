---
{"dg-publish":true,"permalink":"/ctf/shoppy-ctf/"}
---

Shoppy, HackTheBox haftalık makinelerinden exploit etmesi en kolay olanlardan biriydi, ancak ilk adımda exploit edilecek zafiyetleri bulmak biraz zorlayıcı olabiliyor. Öncelikle bir web sitesi bulup, admin giriş sayfasını atlatmak için bir NoSQL enjeksiyonu kullanacağım ve kullanıcıları ve hash'lerini dump için başka bir enjeksiyon yapacağım. Hash kırıldıktan sonra, bir Mattermost sunucusuna giriş yaparak, SSH için çalışan makineye ait kimlik bilgilerini bulacağım. Buradan sonra, bir binary'den statik bir şifre almak için en hafif reverse engineering işlemi yapmam gerekecek, bu da beni bir sonraki kullanıcıya götürecek. Bu kullanıcı **docker** grubunda, bu yüzden host dosya sistemini mount eden bir image yükleyeceğim ve tam disk erişimi elde edeceğim. Bundan sonra, bir shell almak için iki farklı yol göstereceğim. **Beyond Root** bölümünde, zafiyetli web sunucusu kodunun video anlatımını yaparak enjeksiyonların nasıl çalıştığını ve nasıl düzeltilmesi gerektiğini göstereceğim.

## Box Info

|Name|[Shoppy](https://hacktheboxltd.sjv.io/g1jVD9?u=https%3A%2F%2Fapp.hackthebox.com%2Fmachines%2Fshoppy)[![Shoppy](https://0xdf.gitlab.io/icons/box-shoppy.png)](https://hacktheboxltd.sjv.io/g1jVD9?u=https%3A%2F%2Fapp.hackthebox.com%2Fmachines%2Fshoppy)  <br>[Play on HackTheBox](https://hacktheboxltd.sjv.io/g1jVD9?u=https%3A%2F%2Fapp.hackthebox.com%2Fmachines%2Fshoppy)|
|---|---|
|Release Date|[17 Sep 2022](https://twitter.com/hackthebox_eu/status/1570427233277444096)|
|Retire Date|14 Jan 2023|
|OS|Linux ![Linux](https://0xdf.gitlab.io/icons/Linux.png)|
|Base Points|Easy [20]|
|Rated Difficulty|![Rated difficulty for Shoppy](https://0xdf.gitlab.io/img/shoppy-diff.png)|
|Radar Graph|![Radar chart for Shoppy](https://0xdf.gitlab.io/img/shoppy-radar.png)|
|![First Blood User](https://0xdf.gitlab.io/icons/first-blood-user.png)|00:06:03[![22sh](https://www.hackthebox.com/badge/image/143207)](https://app.hackthebox.com/users/143207)|
|![First Blood Root](https://0xdf.gitlab.io/icons/first-blood-root.png)|00:12:37[![22sh](https://www.hackthebox.com/badge/image/143207)](https://app.hackthebox.com/users/143207)|
|Creator|[![lockscan](https://www.hackthebox.com/badge/image/217870)](https://app.hackthebox.com/users/217870)|

## Recon

### nmap

![Pasted image 20250111141103.png](/img/user/resimler/Pasted%20image%2020250111141103.png)

```
nmap -p 22,80,9093 -sCV 10.10.11.180
Starting Nmap 7.94SVN ( https://nmap.org ) at 2025-01-11 06:10 EST
Nmap scan report for 10.10.11.180
Host is up (0.13s latency).

PORT     STATE SERVICE  VERSION
22/tcp   open  ssh      OpenSSH 8.4p1 Debian 5+deb11u1 (protocol 2.0)
| ssh-hostkey: 
|   3072 9e:5e:83:51:d9:9f:89:ea:47:1a:12:eb:81:f9:22:c0 (RSA)
|   256 58:57:ee:eb:06:50:03:7c:84:63:d7:a3:41:5b:1a:d5 (ECDSA)
|_  256 3e:9d:0a:42:90:44:38:60:b3:b6:2c:e9:bd:9a:67:54 (ED25519)
80/tcp   open  http     nginx 1.23.1
|_http-title: Did not follow redirect to http://shoppy.htb
|_http-server-header: nginx/1.23.1
9093/tcp open  copycat?
| fingerprint-strings: 
|   GenericLines: 
|     HTTP/1.1 400 Bad Request
|     Content-Type: text/plain; charset=utf-8
|     Connection: close
|     Request
|   GetRequest: 
|     HTTP/1.0 200 OK
|     Content-Type: text/plain; version=0.0.4; charset=utf-8
|     Date: Sat, 11 Jan 2025 11:11:15 GMT
|     HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime.
|     TYPE go_gc_cycles_automatic_gc_cycles_total counter
|     go_gc_cycles_automatic_gc_cycles_total 3
|     HELP go_gc_cycles_forced_gc_cycles_total Count of completed GC cycles forced by the application.
|     TYPE go_gc_cycles_forced_gc_cycles_total counter
|     go_gc_cycles_forced_gc_cycles_total 0
|     HELP go_gc_cycles_total_gc_cycles_total Count of all completed GC cycles.
|     TYPE go_gc_cycles_total_gc_cycles_total counter
|     go_gc_cycles_total_gc_cycles_total 3
|     HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
|     TYPE go_gc_duration_seconds summary
|     go_gc_duration_seconds{quantile="0"} 1.9587e-05
|     go_gc_duration_seconds{quantile="0.25"} 1.9587e-05
|     go_gc_dur
|   HTTPOptions: 
|     HTTP/1.0 200 OK
|     Content-Type: text/plain; version=0.0.4; charset=utf-8
|     Date: Sat, 11 Jan 2025 11:11:16 GMT
|     HELP go_gc_cycles_automatic_gc_cycles_total Count of completed GC cycles generated by the Go runtime.
|     TYPE go_gc_cycles_automatic_gc_cycles_total counter
|     go_gc_cycles_automatic_gc_cycles_total 3
|     HELP go_gc_cycles_forced_gc_cycles_total Count of completed GC cycles forced by the application.
|     TYPE go_gc_cycles_forced_gc_cycles_total counter
|     go_gc_cycles_forced_gc_cycles_total 0
|     HELP go_gc_cycles_total_gc_cycles_total Count of all completed GC cycles.
|     TYPE go_gc_cycles_total_gc_cycles_total counter
|     go_gc_cycles_total_gc_cycles_total 3
|     HELP go_gc_duration_seconds A summary of the pause duration of garbage collection cycles.
|     TYPE go_gc_duration_seconds summary
|     go_gc_duration_seconds{quantile="0"} 1.9587e-05
|     go_gc_duration_seconds{quantile="0.25"} 1.9587e-05
|_    go_gc_dur
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port9093-TCP:V=7.94SVN%I=7%D=1/11%Time=678251D2%P=x86_64-pc-linux-gnu%r
SF:(GenericLines,67,"HTTP/1\.1\x20400\x20Bad\x20Request\r\nContent-Type:\x
SF:20text/plain;\x20charset=utf-8\r\nConnection:\x20close\r\n\r\n400\x20Ba
SF:d\x20Request")%r(GetRequest,29E6,"HTTP/1\.0\x20200\x20OK\r\nContent-Typ
SF:e:\x20text/plain;\x20version=0\.0\.4;\x20charset=utf-8\r\nDate:\x20Sat,
SF:\x2011\x20Jan\x202025\x2011:11:15\x20GMT\r\n\r\n#\x20HELP\x20go_gc_cycl
SF:es_automatic_gc_cycles_total\x20Count\x20of\x20completed\x20GC\x20cycle
SF:s\x20generated\x20by\x20the\x20Go\x20runtime\.\n#\x20TYPE\x20go_gc_cycl
SF:es_automatic_gc_cycles_total\x20counter\ngo_gc_cycles_automatic_gc_cycl
SF:es_total\x203\n#\x20HELP\x20go_gc_cycles_forced_gc_cycles_total\x20Coun
SF:t\x20of\x20completed\x20GC\x20cycles\x20forced\x20by\x20the\x20applicat
SF:ion\.\n#\x20TYPE\x20go_gc_cycles_forced_gc_cycles_total\x20counter\ngo_
SF:gc_cycles_forced_gc_cycles_total\x200\n#\x20HELP\x20go_gc_cycles_total_
SF:gc_cycles_total\x20Count\x20of\x20all\x20completed\x20GC\x20cycles\.\n#
SF:\x20TYPE\x20go_gc_cycles_total_gc_cycles_total\x20counter\ngo_gc_cycles
SF:_total_gc_cycles_total\x203\n#\x20HELP\x20go_gc_duration_seconds\x20A\x
SF:20summary\x20of\x20the\x20pause\x20duration\x20of\x20garbage\x20collect
SF:ion\x20cycles\.\n#\x20TYPE\x20go_gc_duration_seconds\x20summary\ngo_gc_
SF:duration_seconds{quantile=\"0\"}\x201\.9587e-05\ngo_gc_duration_seconds
SF:{quantile=\"0\.25\"}\x201\.9587e-05\ngo_gc_dur")%r(HTTPOptions,29E6,"HT
SF:TP/1\.0\x20200\x20OK\r\nContent-Type:\x20text/plain;\x20version=0\.0\.4
SF:;\x20charset=utf-8\r\nDate:\x20Sat,\x2011\x20Jan\x202025\x2011:11:16\x2
SF:0GMT\r\n\r\n#\x20HELP\x20go_gc_cycles_automatic_gc_cycles_total\x20Coun
SF:t\x20of\x20completed\x20GC\x20cycles\x20generated\x20by\x20the\x20Go\x2
SF:0runtime\.\n#\x20TYPE\x20go_gc_cycles_automatic_gc_cycles_total\x20coun
SF:ter\ngo_gc_cycles_automatic_gc_cycles_total\x203\n#\x20HELP\x20go_gc_cy
SF:cles_forced_gc_cycles_total\x20Count\x20of\x20completed\x20GC\x20cycles
SF:\x20forced\x20by\x20the\x20application\.\n#\x20TYPE\x20go_gc_cycles_for
SF:ced_gc_cycles_total\x20counter\ngo_gc_cycles_forced_gc_cycles_total\x20
SF:0\n#\x20HELP\x20go_gc_cycles_total_gc_cycles_total\x20Count\x20of\x20al
SF:l\x20completed\x20GC\x20cycles\.\n#\x20TYPE\x20go_gc_cycles_total_gc_cy
SF:cles_total\x20counter\ngo_gc_cycles_total_gc_cycles_total\x203\n#\x20HE
SF:LP\x20go_gc_duration_seconds\x20A\x20summary\x20of\x20the\x20pause\x20d
SF:uration\x20of\x20garbage\x20collection\x20cycles\.\n#\x20TYPE\x20go_gc_
SF:duration_seconds\x20summary\ngo_gc_duration_seconds{quantile=\"0\"}\x20
SF:1\.9587e-05\ngo_gc_duration_seconds{quantile=\"0\.25\"}\x201\.9587e-05\
SF:ngo_gc_dur");
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 123.94 seconds

```


OpenSSH sürümüne göre, host muhtemelen Debian 11 bullseye çalıştırıyor. Port 80 shoppy.htb'ye bir yönlendirme gösteriyor.



### Subdomain Fuzz

DNS adlarının kullanıldığını göz önüne alarak, sunucunun herhangi bir **subdomain**'e farklı tepki verip vermediğini kontrol etmek için **wfuzz** kullanacağım. İlk olarak, filtre olmadan çalıştırarak varsayılan yanıtı kontrol edebilirim:

![Pasted image 20250111141610.png](/img/user/resimler/Pasted%20image%2020250111141610.png)

Görünüşe göre 169 karakter varsayılandır, bu yüzden bunu --hh 169 ile filtreleyeceğim:

![Pasted image 20250111142509.png](/img/user/resimler/Pasted%20image%2020250111142509.png)
![Pasted image 20250111142600.png](/img/user/resimler/Pasted%20image%2020250111142600.png)


Hem shoppy.htb hem de mattermost.shoppy.htb'yi /etc/hosts dosyama ekleyeceğim:

```
10.10.11.180 shoppy.htb mattermost.shoppy.htb
```


### shoppy.htb - TCP 80
#### Site

Sitede sadece mağazanın yakında açılacağı yazıyor:

![Pasted image 20250111142813.png](/img/user/resimler/Pasted%20image%2020250111142813.png)

#### Tech Stack

Varsayılan yol için dosya adlarını tahmin edeceğim, örneğin `/index.html`, `index.php`, ancak hiçbir şey bulamıyorum. Bu, kullanılan teknoloji yığını hakkında bana bir şey söylemiyor, ancak bunun PHP olmadığını ve muhtemelen sadece statik bir site olmadığını, büyük olasılıkla rotalar atayan bir framework olduğunu gösteriyor.

HTTP yanıt başlıkları ek bilgi sağlamıyor.

![Pasted image 20250111150408.png](/img/user/resimler/Pasted%20image%2020250111150408.png)


#### Directory Brute Force

Sitede bağlantılı olmayan yolları aramak için feroxbuster'ı siteye karşı çalıştıracağım:

![Pasted image 20250111150548.png](/img/user/resimler/Pasted%20image%2020250111150548.png)

![Pasted image 20250111151136.png](/img/user/resimler/Pasted%20image%2020250111151136.png)

/admin ve /login en ilginç olanlarıdır (ancak ilki sadece ikincisine yönlendirir)

#### /login

/login bir giriş formu verir:

![Pasted image 20250111151232.png](/img/user/resimler/Pasted%20image%2020250111151232.png)

Birkaç tahmin denedim, var olmayan kullanıcı ile yanlış şifre arasında belirgin bir fark yok (yine de bir admin kullanıcısı olduğundan emin değilim). Girdiğim her şey sadece “Yanlış Kimlik Bilgileri” döndürüyor:

![Pasted image 20250111151303.png](/img/user/resimler/Pasted%20image%2020250111151303.png)


### mattermost.shoppy.htb - TCP 80

#### Site

Bu, açık kaynaklı bir Slack alternatifi olan **[Mattermost](https://github.com/mattermost/mattermost-server)**'un bir örneğine benziyor. `/login` adresine bir giriş formuna yönlendiriyor.

![Pasted image 20250111151417.png](/img/user/resimler/Pasted%20image%2020250111151417.png)

#### Tech Stack

Header'lar hala NGINX olduğunu gösteriyor, ancak başka bir şey yok:

```
HTTP/1.1 200 OK
Server: nginx/1.23.1
Date: Sat, 11 Jan 2025 12:15:34 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 3122
Connection: keep-alive
Accept-Ranges: bytes
Cache-Control: no-cache, max-age=31556926, public
Content-Security-Policy: frame-ancestors 'self'; script-src 'self' cdn.rudderlabs.com
Last-Modified: Sat, 11 Jan 2025 11:08:44 GMT
X-Frame-Options: SAMEORIGIN
X-Request-Id: 16su6ceqsin9zp6fhwo3y87hoa
X-Version-Id: 7.1.2.7.1.2.c5e71b88555e841d57187938dfbf41ec.false
```

Çalıştırdığı sürüm hakkında herhangi bir ipucu için sayfa kaynağını ve JavaScript dosyalarını biraz kurcalayacağım, ancak şanssızım.

Sayfanın altındaki telif hakkı 2023 diyor (kutu yayınlandıktan sonra), bu yüzden dinamik olarak güncelleniyor olmalı.


#### Vulnerabilities

Burada **dizin brute force** işlemine geçmeyeceğim, bunun yerine potansiyel güvenlik açıklarını aramaya odaklanacağım. Ancak ne Google ne de **searchsploit** işe yarar bir şey bulamıyor. Tüm CVE'ler düşük etkiye sahip görünüyor. Bazı kimlik bilgileri bulup giriş yapabildiğimde buraya geri dönmem gerekecek.


### HTTP - TCP 9093

Bunu HTTP üzerinden ziyaret etmek bir tür log döndürür:

![Pasted image 20250111151820.png](/img/user/resimler/Pasted%20image%2020250111151820.png)

Görünüşe göre, bu veriler Go programlama dilinin çalışma zamanı (runtime) hakkında bilgi sağlayan metrikler. Bu tür veriler genellikle bir uygulamanın bellek kullanımı, çöp toplama (garbage collection - GC) processleri, ve sistemin genel sağlık durumu hakkında detaylı bilgiler içerir.

Bunun ne olduğunu anlamaya çalışırken biraz araştırmaya daldım. **Port 9093**, **Mattermost** için **Prometheus AlertManager Plugin** ile ilişkilendiriliyor, bu da bu olabilir.

Dosyanın alt kısmında **playbook_plugin_process** sıkça geçiyor. Bu da bir [**Mattermost**](https://github.com/mattermost/mattermost-plugin-playbooks) özelliği olabilir.

![Pasted image 20250111152118.png](/img/user/resimler/Pasted%20image%2020250111152118.png)

Neyse ki, burada bana çok faydalı görünen fazla bilgi yok.


## Shell as jaeger

### Admin Auth ByPass

#### Not SQL Injection

Bir form gördüğümde her zaman hızlı bir şekilde birkaç SQL enjeksiyon payload'u yerleştiririm. Bu durumda, oturum açma isteğini Burp Repeater'a göndereceğim ve basit bir ' eklemeyi deneyeceğim. İstek tam bir dakika bekletildikten sonra 504 Gateway Time-out döndürüyor:

![Pasted image 20250111152430.png](/img/user/resimler/Pasted%20image%2020250111152430.png)

![Pasted image 20250111152807.png](/img/user/resimler/Pasted%20image%2020250111152807.png)

Bu, sunucunun bu istekle gerçekten zor zamanlar geçirdiğini gösteriyor ve hiçbir şey olmayabilir veya bir şey olabilir.

Denediğim başka hiçbir SQL enjeksiyon payload'u farklı bir şey döndürmüyor.

#### NoSQL Hataları

' sunucuyu bozduğu için NoSQL'e de bakacağım. Bunu denemenin bir yolu [Mango](https://0xdf.gitlab.io/2020/04/18/htb-mango.html#nosql-inejction-login-bypass)'da gösterdiğim gibi bir şey olabilir:

```
username[$ne]=admin&password[$ne]=admin
```

Burası için işe yaramaz ve aynı şekilde takılmasına neden olur.

Başka bir yöntem, JSON formatına dönüştürmektir. ==**Content-Type**== başlığını ve **payload**'ı değiştireceğim. Enjeksiyon olmadan, bu düzgün çalışır (girişin başarısız olduğunu belirten 302 döner).

![Pasted image 20250111153146.png](/img/user/resimler/Pasted%20image%2020250111153146.png)

![Pasted image 20250111153152.png](/img/user/resimler/Pasted%20image%2020250111153152.png)

Şimdi [NodeBlog](https://0xdf.gitlab.io/2022/01/10/htb-nodeblog.html#auth-bypass-via-nosql-injection)'da işe yarayan yöntemi deneyebilirim, ancak takılıyor ve nihayetinde bir zaman aşımı hatası döndürüyor.

![Pasted image 20250111154238.png](/img/user/resimler/Pasted%20image%2020250111154238.png)

![Pasted image 20250111154354.png](/img/user/resimler/Pasted%20image%2020250111154354.png)

Bir noktada yanlışlıkla “$ne” kelimesini etrafında “ işareti olmadan gönderdim ve bu da 400 değerini döndürdü:

![Pasted image 20250111154409.png](/img/user/resimler/Pasted%20image%2020250111154409.png)

Bu yanıtı işlemek bir hata izi gösteriyor.

![Pasted image 20250111154454.png](/img/user/resimler/Pasted%20image%2020250111154454.png)

$ karakterini sevmediğini ve bu durumun JSON ayrıştırma seviyesinde, potansiyel bir veritabanı çağrısına ulaşmadan önce olduğunu fark ettim. Burada bir çıkmaz gibi görünüyor. Ancak ilginç bazı bilgiler sızdırdım:

- Kullanıcı adı: jaeger
- Uygulama, `/home/jaeger/ShoppyApp` dizininde çalışıyor.

Bu bilgiler, doğrudan bir giriş sağlamak için önemli olmayabilir, ancak genel olarak faydalı olabilecek türde bilgiler.

#### NoSQL Injection Success

NoSQL sorgularına yönelik, SQL enjeksiyonuna daha çok benzeyen bir saldırı tekniği var ve bunu Null Sweep'teki bu [makalede](https://nullsweep.com/a-nosql-injection-primer-with-mongo/) buldum. Bu yazıda bahsedilen aracı ([nosqli](https://github.com/Charlie-belmer/nosqli)) denemek istedim, ancak çok sayıda payload gönderdiğimde yaşanan takılma, aracın başarısız olmasına neden oluyor.

Makalenin sonunda şu örneği veriyorlar:

Ve kullanıcıları `' || 'a'=='a'` ile nasıl alabileceklerini gösteriyorlar.

Ben de bu tür payload'ları username alanında denemeyi seviyorum, çünkü çoğu zaman password alanı kullanılmadan önce hash'leniyordur. Bu payload'a geri dönerek (ve ==Content-Type=='ı tekrar `application/x-www-form-urlencoded` olarak görerek):

```
username=admin' || 'a'=='a&password=admin
```


![Pasted image 20250111154916.png](/img/user/resimler/Pasted%20image%2020250111154916.png)

Sonuçlar geldi:

```
HTTP/1.1 302 Found

Server: nginx/1.23.1

Date: Sat, 11 Jan 2025 12:49:06 GMT

Content-Type: text/html; charset=utf-8

Content-Length: 56

Connection: keep-alive

Location: /admin

Vary: Accept

Set-Cookie: connect.sid=s%3AycDpGIQ2e2Ts02LuxbrOzIjTGmP_Z_ul.c6lA8gz9SNFY7R%2B77iHM6IhrNP1NbS3zRgCVRikoZCk; Path=/; HttpOnly



<p>Found. Redirecting to <a href="/admin">/admin</a></p>
```


Bu, bir cookie set edilmesi ve /admin sayfasına yönlendirme! Başarı bu.

İlginç bir şekilde, bu sadece kullanıcı adı varsa çalışıyor. Eğer payload'ı şu şekilde değiştirirsem:

```
username=0xdf' || 'a'=='a&password=admin
```

“Wrong Credentials” ile yeniden yönlendiriyor.

Beyond Root'ta bu ve başka bir NoSQL güvenlik açığını inceleyeceğim.

### Access to Mattermost

#### Enumeration


Repeater'dan cookie alarak ya da NoSQL payload ile Firefox'tan giriş yaparak admin paneline girebiliyorum:

![Pasted image 20250111155246.png](/img/user/resimler/Pasted%20image%2020250111155246.png)

Bu sayfa nispeten statik görünüyor. "Search for users" butonu, /admin/search-users sayfasına yönlendiriyor.,

![Pasted image 20250111155337.png](/img/user/resimler/Pasted%20image%2020250111155337.png)


Eğer “random” için arama yaparsam, hiçbir şey bulamıyor. “admin” için arama yaparsam, bir indirme sunuyor:

![Pasted image 20250111155421.png](/img/user/resimler/Pasted%20image%2020250111155421.png)



![Pasted image 20250111155402.png](/img/user/resimler/Pasted%20image%2020250111155402.png)

Admin'in kimliğini, kullanıcı adını ve şifresini içeren export-search.json dosyasını açar:

![Pasted image 20250111155448.png](/img/user/resimler/Pasted%20image%2020250111155448.png)
![Pasted image 20250111155557.png](/img/user/resimler/Pasted%20image%2020250111155557.png)

Hash MD5'e benziyor, ancak rockyou.txt ile kırılmıyor.

![Pasted image 20250111155701.png](/img/user/resimler/Pasted%20image%2020250111155701.png)


#### NoSQL Injection Again

Uygulama zaten NoSQL enjeksiyonuna karşı savunmasız olduğunu göstermişti, bu yüzden tekrar deneyeceğim:

![Pasted image 20250111155726.png](/img/user/resimler/Pasted%20image%2020250111155726.png)

Bu, isim "admin" olduğunda veya `1==1` olduğunda (ki bu her zaman doğrudur!) bir kayıt alır. İşe yarıyor, sonuç olarak dosyada ikinci bir hesap var.

![Pasted image 20250111155836.png](/img/user/resimler/Pasted%20image%2020250111155836.png)


#### Crack Hash

MD5 hash'leri (bunun gibi 32 hex karakter uzunluğundadır) salt falan değildir, dolayısıyla aynı girdinin hash'i her zaman aynıdır. Rockyou gibi kelime listeleri (HTB'de tipik olarak kullanılan) zaten tüm hash'lerini crackstation gibi şeylerin erişebileceği rainbow tablolarında saklamışlardır. 

admin için

![Pasted image 20250111160008.png](/img/user/resimler/Pasted%20image%2020250111160008.png)

josh için Anında geri geliyor:

![Pasted image 20250111160024.png](/img/user/resimler/Pasted%20image%2020250111160024.png)


#### Log into Mattermost

Bu şifre ile josh kullanıcı adı Mattermost'ta oturum açar:

![Pasted image 20250111160116.png](/img/user/resimler/Pasted%20image%2020250111160116.png)

### Jaeger için Creds

Farklı channel'ları okurken, çoğu sadece havadan sudan konuşuyor, ancak iki channel'da ilginç bilgiler var.

Chat'teki iki ilginç konuşmacı Josh ve Jaeger. Josh'un profilinde bir developer olduğu, Jaeger'in ise CEO olduğu görülüyor:

![Pasted image 20250111160350.png](/img/user/resimler/Pasted%20image%2020250111160350.png)

![Pasted image 20250111160346.png](/img/user/resimler/Pasted%20image%2020250111160346.png)

![Pasted image 20250111160418.png](/img/user/resimler/Pasted%20image%2020250111160418.png)

![Pasted image 20250111160428.png](/img/user/resimler/Pasted%20image%2020250111160428.png)

Public “Development” kanalında Josh, C++'da bir password manager yapmaktan bahsediyor. Bir shell aldığımda buna göz atacağım:

![Pasted image 20250111160523.png](/img/user/resimler/Pasted%20image%2020250111160523.png)

“ Deploy Machine” gizli kanalında Josh ve Jaeger arasında başka bir konuşma var. Jaeger bir kullanıcı adı ve parola ile bir makine kurulmasını istiyor:

![Pasted image 20250111160555.png](/img/user/resimler/Pasted%20image%2020250111160555.png)

### SSH

Bu kimliklerle, kutuya jaeger olarak SSH yapabilirim:

![Pasted image 20250111161047.png](/img/user/resimler/Pasted%20image%2020250111161047.png)

Doğrudan bağlanmak hata veriyor . Çıkat ayrıntıları chatgpt'ye verdiğimde doğru kodu buldum . 

![Pasted image 20250111161356.png](/img/user/resimler/Pasted%20image%2020250111161356.png)

---

Farkı nedir ? 

Bu komut, öncekinden farklı olarak **parola doğrulamasını zorlamak** ve **anahtar tabanlı kimlik doğrulamasını devre dışı bırakmak** için bazı ek parametreler içeriyor.

İşte farklar:

1. **`-o PreferredAuthentications=password`**: Bu parametre, SSH bağlantısının yalnızca **parola tabanlı kimlik doğrulama** kullanmasını sağlar. Böylece, anahtar tabanlı kimlik doğrulama geçerli olmasa bile şifre ile doğrulama yapılır.
    
2. **`-o PubkeyAuthentication=no`**: Bu parametre, **anahtar tabanlı kimlik doğrulamanın devre dışı bırakılmasını** sağlar. Yani, anahtar tabanlı doğrulama işlemi yapılmaz, sadece parola doğrulaması yapılır.
    

### Önceki Komut ve Bu Komut Arasındaki Farklar:

- İlk komutta, SSH sunucusunun **her iki kimlik doğrulama yöntemi** (anahtar ve parola) arasında seçim yapmasına izin veriliyordu.
- Bu yeni komutta ise yalnızca **parola doğrulama** kullanılıyor ve **anahtar tabanlı doğrulama tamamen devre dışı bırakılıyor**.

Bu nedenle, bu komut sayesinde sadece **parola doğrulaması** yapılacak ve bu da bağlantı sağlanmasını mümkün kılmış olabilir. Anahtar tabanlı kimlik doğrulama sorun yaratıyorsa, bu yöntemle başarı sağlanmış olur.


---

## Shell as deploy

### Enumeration

jaeger /home/deploy/password-manager öğesini deploy olarak çalıştırabilir:

![Pasted image 20250111161518.png](/img/user/resimler/Pasted%20image%2020250111161518.png)

`/home/deploy` dosyasında binary dosyanın yanı sıra source ve `creds.txt` dosyası da bulunmaktadır:

![Pasted image 20250111161639.png](/img/user/resimler/Pasted%20image%2020250111161639.png)

Jaeger olarak sadece binary dosyasını okuyabiliyorum. `Sudo` ile deploy olarak da çalıştırabilirim:

![Pasted image 20250111161914.png](/img/user/resimler/Pasted%20image%2020250111161914.png)

Scp ile makineme geri kopyalayacağım:

![Pasted image 20250111162017.png](/img/user/resimler/Pasted%20image%2020250111162017.png)

### Reverse Engineering

#### Ghidra

Binary 64-bit ELF'dir:

![Pasted image 20250111162049.png](/img/user/resimler/Pasted%20image%2020250111162049.png)

Ghidra'da incelemek için açacağım. C++ Ghidra'da karmaşık, ama program oldukça basit.

Hoş geldiniz ve şifre promptunu  yazdırıyor:

![Pasted image 20250111164710.png](/img/user/resimler/Pasted%20image%2020250111164710.png)

export --> main

![Pasted image 20250111164831.png](/img/user/resimler/Pasted%20image%2020250111164831.png)

Hoş geldiniz ve şifre prompt'unu yazdırır.

![Pasted image 20250111165940.png](/img/user/resimler/Pasted%20image%2020250111165940.png)

Daha sonra bir string oluşturur ve input içine kaydeder:

![Pasted image 20250111170008.png](/img/user/resimler/Pasted%20image%2020250111170008.png)

Şimdi başka bir string oluşturur ve ona “S”, “a”, “m”, “p”, “l”, “e” karakterlerini ekler:

![Pasted image 20250111170701.png](/img/user/resimler/Pasted%20image%2020250111170701.png)

Input'u “Sample” ile karşılaştırır ve eşleşmezlerse (pass_match'te 0 olmayan return), “Access denied!” mesajını yazdırır:

![Pasted image 20250111170748.png](/img/user/resimler/Pasted%20image%2020250111170748.png)

Aksi takdirde, “ Access granted” yazdırır ve ardından system(“cat /home/deploy/creds.txt”) çağrısı yapar:

![Pasted image 20250111170826.png](/img/user/resimler/Pasted%20image%2020250111170826.png)

#### strings

Yazar, şifreyi her karakteri bir seferde ekleyerek saklamayı tercih etmiş. Bu yöntemle, şifre doğrudan dizelerde görünmez. Ancak bu yöntemin etkili olup olmadığını görmek için, hex (onaltılık) çıktı üzerinde inceleme yapıyoruz. "xxd" komutunu kullanarak, password manager'ın binary dosyasındaki verileri hex formatında görüntülüyoruz.

![Pasted image 20250111171151.png](/img/user/resimler/Pasted%20image%2020250111171151.png)


![Pasted image 20250111171245.png](/img/user/resimler/Pasted%20image%2020250111171245.png)

![Pasted image 20250111171318.png](/img/user/resimler/Pasted%20image%2020250111171318.png)

![Pasted image 20250111171402.png](/img/user/resimler/Pasted%20image%2020250111171402.png)

su, kullanıcıları şifreleri ile değiştirmeme izin veriyor:

deploy varsayılan shell olarak sh'ye sahip gibi görünüyor, ama ben bash'e geçeceğim. Bunu /etc/passwd dosyasında görebiliyorum:

![Pasted image 20250111171602.png](/img/user/resimler/Pasted%20image%2020250111171602.png)

![Pasted image 20250111171621.png](/img/user/resimler/Pasted%20image%2020250111171621.png)

![Pasted image 20250111171634.png](/img/user/resimler/Pasted%20image%2020250111171634.png)

## Shell as root

### Enumeration

home/deploy içinde başka ilginç bir dosya yok ve dosya sisteminde başka hiçbir şey göze çarpmıyor.

deploy ek bir grupta yer almaktadır:

![Pasted image 20250111171707.png](/img/user/resimler/Pasted%20image%2020250111171707.png)

docker kutuya yüklenir ve docker grubunda konuşlandırıldığı için, hiçbir konteyner çalışmıyor olsa da onunla etkileşime girebilirler:

![Pasted image 20250111171738.png](/img/user/resimler/Pasted%20image%2020250111171738.png)

"Kutuda bir tane image var, [Alpine](https://hub.docker.com/_/alpine), çok küçük bir image ve sınırlı işlevselliğe sahip."

![Pasted image 20250111171847.png](/img/user/resimler/Pasted%20image%2020250111171847.png)


### Access Filesystem as root

#### Basic

Buradaki exploit, tüm dosya sistemini içine monte edilmiş yeni bir container oluşturmak. O container içinde root olacağım ve böylece container içindeki tüm dosyalara (tam olarak ana makine dosya sistemi dahil) erişimim olacak.

Bunu daha önce lxc ile birkaç kez gösterdim, ancak Docker ile hiç böyle yapmamıştım ([GoodGames](https://0xdf.gitlab.io/2022/02/23/htb-goodgames.html#shell-1) en yakın örnektir).

Container’ı docker run komutu ve aşağıdaki seçeneklerle başlatacağım:

* `--rm` - container işini bitirdiğinde kaldırılacak  
* `-it` - STDIN'i açık tutacak ve bir PTTY atayacak  
* `-v` /:/mnt - ana makinenin `/` dizinini container içindeki `/mnt`'ye monte edecek

Ayrıca, image ismini (alpine) ve çalıştırılacak komutu (`/bin/sh`, çünkü Alpine'de `bash` yok) vereceğim. Bunlarla image’ı başlatabilir ve host'un dosya sistemini `/mnt` içinde bulabilirim.

![Pasted image 20250111172208.png](/img/user/resimler/Pasted%20image%2020250111172208.png)

#### Neat Upgrade

[Docker GTFObins](https://gtfobins.github.io/gtfobins/docker/) sayfasındaki güzel bir numara, komut olarak sh yerine chroot kullanmaktır. Gerçekten konteyner dosya sistemine ihtiyacım yok. Bu yüzden chroot /mnt /bin/sh komutunu vereceğim (çalıştırılacak bir komut da veriyorum, [man sayfasına](https://linux.die.net/man/1/chroot) bakabilirsiniz). Bu, dosya sisteminin kökünü /mnt olarak ayarlayacak ve ardından bir shell çalıştıracak. Bu, sanki tekrar sadece host üzerinde çalışıyormuşum gibi bir his veriyor.

![Pasted image 20250111172344.png](/img/user/resimler/Pasted%20image%2020250111172344.png)

![Pasted image 20250111172601.png](/img/user/resimler/Pasted%20image%2020250111172601.png)

![Pasted image 20250111172607.png](/img/user/resimler/Pasted%20image%2020250111172607.png)


## Beyond Root - NoSQL Injection

Bu [videoda](https://www.youtube.com/watch?v=EfLW51f6KFo), Shoppy'ye bağlanmak için VSCode kullanacağım ve NoSQL enjeksiyonlarını daha iyi anlamak için web sitesinin NodeJS kodunu analiz edeceğim. Ardından güvenlik açıklarını düzelteceğim ve artık exploit edilemeyeceklerini göstereceğim:

Videoda değinmediğim bir konu da bu enjeksiyon için boole mantığının nasıl çalıştığıydı. `admin'||'a'=='a` enjeksiyonu ile sorgu şu hale gelir:

```
this.username == 'admin' || 'a'=='a' && this.password == '0xdf'
```

İşte bu:

```
true || true && false
```

Bu nasıl değerlendiriliyor? Bir tarayıcıda kontrol edebilirim:

![Pasted image 20250111200151.png](/img/user/resimler/Pasted%20image%2020250111200151.png)

Ama neden işe yarıyor? JavaScript için [Operatör Önceliği](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Operator_Precedence#table), operatörleri 18'den 1'e kadar işlenen 1-18 numaralı gruplar halinde gruplandırır. Mantıksal AND (&&) 4. grupta ve Mantıksal OR (||) 3. grupta yer alır:

![Pasted image 20250111200235.png](/img/user/resimler/Pasted%20image%2020250111200235.png)

Dolayısıyla, admin kullanıcı için sorgu her satırda biraz daha basitleştirilebilir:

```
this.username == 'admin' || 'a'=='a' && this.password == '0xdf'
true || true && false
true || false
true
```
